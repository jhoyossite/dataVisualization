<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .bar {
        fill: steelblue;
    }

    .bar:hover {
        fill: brown;
    }

    .axis--x path {
        display: none;
    }
    
    body{
        margin:20px;
    }
</style>
<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap-3.3.7-dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container"style="margin-top:40px;">
        <div class="jumbotron">
            <h1>Data visualization</h1>
            <p>Realizar una visualización basado en la base de datos de costos de proveedores a lo largo del tiempo en la empresa XXXXX S.A.</p>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">Goal</div>
            <div class="panel-body">Presentar</div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">About the data (What)</div>
            <div class="panel-body"> La base de datos bajo estudio es una tabla estatica, cuyas filas estan relacionados con atributos especificos. A continuacion se muestra la descripcion de los mismos:
              <div class="table-responsive">
                <table class="table table-condensed">
                  <thead>
                    <tr>
                      <th>Nombre del Atributo</th>
                      <th>Tipo de Atributo</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Fecha Contabilizacion</td>
                      <td>Cuantitativo Incremental</td>
                    </tr>
                    <tr>
                      <td>Proveedor</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Categoria</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Procesos</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Servicios</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Valor Neto</td>
                      <td>Cuantitativo Secuencial</td>
                    </tr>
                    <tr>
                      <td>Cantidad</td>
                      <td>Cuantitativo Secuencial</td>
                    </tr>
                    <tr>
                      <td>UMB</td>
                      <td>Cuantitativo Secuencial</td>
                    </tr>
                    <tr>
                      <td>Texto Breve</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Texto Breve Servicio</td>
                      <td>Categorico</td>
                    </tr>
                  </tbody>
                </table>
              </div> 
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">Task (Why)</div>
            <div class="panel-body">
                <span>T1. Tomar el presupuesto que se tiene por centro gestor para subcontrataciones y realiza comparación con el valor que se gasta en cada una.</span><br>
                <span>T2. <b>Presentar</b> los <i>costos</i> (<b>Attribute</b>) por categoría (<b>Attribute</b>) para cada centro gestor en cada uno de los años.</span><br>
                <span>T3. <b>Identificar</b> la <i>categoría</i> (<b>Attribute</b>) que más gasta (<b>Feature</b>) en subcontrataciones.</span><br>
                <span>T4. <b>Presentar</b> la tendencia de los costos por proveedor a lo largo del tiempo, ya sea por <i>centro gestor</i> o <i>categoria</i> (<b>Attribute</b>)</span><br>
                <span>T5. Mostrar costos por año</span></div>
        </div>
        <span>Para el desarrollo de la T2 se plantea la siguiente visualización: <br><br></span>
        <div class="panel panel-default col-md-12">
            <div class="panel-body">
                <svg width="1000" height="400"></svg>
            </div>
        </div>
        <div class="panel panel-default col-md-6">
            <div class="panel-body" id="second">
            </div>
        </div>
        <div class="panel panel-default col-md-6">
            <div class="panel-body" id="legendSecond">
            </div>
        </div>
    </div>
</body>
<script>
    // Variables que se definen para el primer gráfico de barras que muestra el monto gastado por categoria
    var svg    = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width  = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;

    var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
        y = d3.scaleLinear().rangeRound([height, 0]);
      
    var g = svg.append("g")
               .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    
    // varibales que se definen para la creación del segundo grafico
    var diameter = 500, //max size of the bubbles
    color        = d3.scaleOrdinal(d3.schemeCategory20c); //color category

    var pack = d3.pack()
                   .size([diameter, diameter])
                   .padding(1.5);
    
    var svg = d3.select("#second")
                .append("svg")
                .attr("width", diameter)
                .attr("height", diameter)
                .attr("class", "bubble");

    // Se realiza el llamado a la función para crear cada elemento del gráfico basado en los datos
    function update(myData){
        x.domain(myData.sort(function(a, b) { return b.value - a.value; }).map(function(d) { return d.key; }));
        y.domain([0, d3.max(myData, function(d) { return d.value; })]);

  		g.append("g")
      	 .attr("class", "axis axis--x")
      	 .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(x))
         .append("text")
         .text("Centro gestor");
      	 

        g.append("g")
      	 .attr("class", "axis axis--y")
      	 .call(d3.axisLeft(y))
         .append("text")
      	 .attr("transform", "rotate(-90)")
      	 .attr("y", 6)
      	 .attr("dy", "0.71em")
      	 .attr("text-anchor", "end")
      	 .text("Valor neto");

        g.selectAll(".bar")
         .data(myData)
         .enter().append("rect")
      	 .attr("class", "bar")
      	 .attr("x", function(d) {return x(d.key); })
      	 .attr("y", function(d) {return y(d.value); })
      	 .attr("width", x.bandwidth())
      	 .attr("height", function(d) { return height - y(d.value); });

    }
    
    function update2(myData){
        var root = d3.hierarchy({children: myData})
                     .sum(function(d) { return d.value; })
                     .each(function(d) {
                         d.id       = d.data.key;
                         if (id = d.data.key) {
                            var name   = d.data.key.split('-'); 
                            d.category = name[0];
                            d.anio     = name[1];
                         }
                        //}
                    });
        
        
        var node = svg.selectAll(".node")
                      .data(pack(root).leaves())
                      .enter().append("g")
                      .attr("class", "node")
                      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        
        node.append("circle")
            .attr("id", function(d) { return d.id; })
            .attr("r", function(d) { return d.r; })
            .style("fill", function(d) { return color(d.category); });
        
        node.append("clipPath")
            .attr("id", function(d) { return "clip-" + d.id; })
            .append("use")
            .attr("xlink:href", function(d) { return "#" + d.id; });
        
        var legend = svg.selectAll(".legend")
                    .data(ageNames.slice().reverse())
                    .enter().append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });

        /*node.append("text")
            .attr("clip-path", function(d) { return "url(#clip-" + d.anio + ")"; })
            .style("font-size","10px")
            .selectAll("tspan")
            .data(function(d) { return d.anio; })
            .enter().append("tspan")
            .attr("y", 0)
            .attr("x", function(d, i, nodes) { return 13 + (i - nodes.length / 2 - 0.5) * 10; })
            .text(function(d) { return d; });*/

        node.append("title")
            .text(function(d) { return d.id + "\n" + d.value; });
    }
    
    // Lectura del archivo con los datos
    d3.csv("data.csv", function(err, data){
      var data2 = d3.nest()
                    .key(function(d) { return d["Procesos"]; })
                    .rollup(function(v) { return d3.sum(v, function(d) { return d["Valor neto"]; }); })
                    .entries(data);

        var legendData = d3.keys(data);
        
        console.log(legendData);
    

        
      var data3 = d3.nest()
                    .key(function(d) { var date = d['Fecha contabilizacion'].split('/'); 
                                       return d["Procesos"]+'-20'+date[2]; })
                    .rollup(function(v) { return d3.sum(v, function(d) { return d["Valor neto"]; }); })
                    .entries(data);  
        
        

        update(data2);
        update2(data3);
    })

/*d3.json("prueba.json", function(d) {
  //d["valor neto"] = +d["valor neto"];
  console.log(d);
  return d;
}, function(error, data) {
  if (error) throw error;
	console.log(data);
  x.domain(data.map(function(d) { return d.letter; }));
  y.domain([0, d3.max(data, function(d) { return d.frequency; })]);

  g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(10, "%"))
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("text-anchor", "end")
      .text("Frequency");

  g.selectAll(".bar")
    .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.letter); })
      .attr("y", function(d) { return y(d.frequency); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.frequency); });
});*/

  </script>
