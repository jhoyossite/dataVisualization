<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .bar {
        fill: steelblue;
    }

    .bar:hover {
        fill: brown;
    }

    /*.axis--x path {
        display: none;
    }*/
    
    body{
        margin:20px;
    }
    
    
    .axis--x path {
        display: none;
    }

    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
    }

    #graph, .sizeSvg {
    width: 910px;
    height: 500px;
    }
    .tick line {
        stroke-dasharray: 2 2 ;
        stroke: #ccc;
    }
</style>
<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap-3.3.7-dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container"style="margin-top:40px;">
        <div class="jumbotron">
            <h1>Data visualization</h1>
            <p>Realizar una visualización basado en la base de datos de costos de proveedores a lo largo del tiempo en la empresa XXXXX S.A.</p>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">Goal</div>
            <div class="panel-body">Presentar</div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">About the data (What)</div>
            <div class="panel-body"> La base de datos bajo estudio es una tabla estatica, cuyas filas estan relacionados con atributos especificos. A continuacion se muestra la descripcion de los mismos:
              <div class="table-responsive">
                <table class="table table-condensed">
                  <thead>
                    <tr>
                      <th>Nombre del Atributo</th>
                      <th>Tipo de Atributo</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Fecha Contabilizacion</td>
                      <td>Cuantitativo Incremental</td>
                    </tr>
                    <tr>
                      <td>Proveedor</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Categoria</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Procesos</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Servicios</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Valor Neto</td>
                      <td>Cuantitativo Secuencial</td>
                    </tr>
                    <tr>
                      <td>Cantidad</td>
                      <td>Cuantitativo Secuencial</td>
                    </tr>
                    <tr>
                      <td>UMB</td>
                      <td>Cuantitativo Secuencial</td>
                    </tr>
                    <tr>
                      <td>Texto Breve</td>
                      <td>Categorico</td>
                    </tr>
                    <tr>
                      <td>Texto Breve Servicio</td>
                      <td>Categorico</td>
                    </tr>
                  </tbody>
                </table>
              </div> 
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">Task (Why)</div>
            <div class="panel-body">
                <span>T1. Tomar el presupuesto que se tiene por centro gestor para subcontrataciones y realiza comparación con el valor que se gasta en cada una.</span><br>
                <span>T2. <b>Presentar</b> los <i>costos</i> (<b>Attribute</b>) por categoría (<b>Attribute</b>) para cada centro gestor en cada uno de los años.</span><br>
                <span>T3. <b>Identificar</b> la <i>categoría</i> (<b>Attribute</b>) que más gasta (<b>Feature</b>) en subcontrataciones.</span><br>
                <span>T4. <b>Presentar</b> la tendencia de los costos por proveedor a lo largo del tiempo, ya sea por <i>centro gestor</i> o <i>categoria</i> (<b>Attribute</b>)</span><br>
                <span>T5. Mostrar costos por año</span></div>
        </div>
        <span>Para el desarrollo de la T1 se plantea la siguiente visualización: <br><br></span>
        <div class="panel panel-default col-md-12">
            <select class="toogleBtn" onchange="loadData()" id="metric">
              <option >2014</option>
              <option >2015</option>
              <option >2016</option>
            </select>
            <div class="btn-group tootleBtn" role="group" aria-label="Basic example">
              <button type="button" class="btn btn-secondary">2014</button>
              <button type="button" class="btn btn-secondary">2015</button>
              <button type="button" class="btn btn-secondary">2016</button>
            </div>
            <div class="panel-body" id="graph">   
            </div>
        </div>
        <span>Para el desarrollo de la T1 se plantea la siguiente visualización: <br><br></span>
        <div class="panel panel-default col-md-12">
            <div class="panel-body">
                <svg id="t1" width="1000" height="1000"></svg>
            </div>
        </div>
        <div class="panel panel-default col-md-12">
            <div class="panel-body" id="second">
            </div>
        </div>
        <span>Para el desarrollo de la T2 se plantea la siguiente visualización: <br><br></span>
        <div class="panel panel-default col-md-12">
            <div class="panel-body">
                <div class="form-group col-md-4">
                    <label>Filtrar por proceso:</label>
                    <select id="procesos" class="form-control input-sm">
                    </select>
                </div>
                <svg id="t2" width="1000" height="500"></svg> 
            </div>
        </div>
    </div>
</body>
<script src="task1.js"></script>
<script>
    // Variables que se definen para el primer gráfico de barras que muestra el monto gastado por categoria
    var svg    = d3.select("#t1"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width  = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;

    var y      = d3.scaleBand().rangeRound([0, height]).padding(0.1),
        x      = d3.scaleLinear().rangeRound([0, width]);
      
    var g      = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    // Variables que se definen para la creación del segundo grafico
    var diameter = 650, //max size of the bubbles
    color        = d3.scaleOrdinal(d3.schemeCategory20c); //color category

    var pack     = d3.pack()
                     .size([diameter, diameter])
                     .padding(1.5);
    
    var svg      = d3.select("#second")
                     .append("svg")
                     .attr("width", diameter+400)
                     .attr("height", diameter)
                     .attr("class", "bubble");
    
    // Variables que se definen para la grafica 3 de la tarea 2
    var svg2       = d3.select("#t2"),
    margin2        = {top: 20, right: 80, bottom: 30, left: 50},
    width2         = svg2.attr("width") - margin2.left - margin2.right,
    height2        = svg2.attr("height") - margin2.top - margin2.bottom,
    g2             = svg2.append("g").attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

    var parseTime  = d3.timeParse("%Y%m%d");

    var x2         = d3.scaleTime().range([0, width2+30]),
        y2         = d3.scaleLinear().range([height2, 0]),
        z2         = d3.scaleOrdinal(d3.schemeCategory10);

    var line = d3.line()
                 .curve(d3.curveBasis)
                 .x(function(d) { return x2(parseTime(d.key))+30; })
                 .y(function(d) { return y2(d.value); });
    
    var data3    = false;
    var dataInit = false;

    // Se realiza el llamado a la función para crear cada elemento del gráfico basado en los datos
    function update(myData){
        y.domain(myData.sort(function(a, b) { return b.value - a.value; }).map(function(d) { return d.key; }));
        x.domain([0, d3.max(myData, function(d) { return d.value; })]);

  		g.append("g")
      	 .attr("class", "axis axis--x")
      	 .attr("transform", "translate(30," + height + ")")
         .call(d3.axisBottom(x))
         .append("text")
         .text("Centro gestor");
      	 

        g.append("g")
      	 .attr("class", "axis axis--y")
         .attr("transform", "translate(30," + 0 + ")")
      	 .call(d3.axisLeft(y))
         .append("text")
      	 .attr("transform", "rotate(-90)")
      	 .attr("y", 6)
      	 .attr("dy", "0.71em")
      	 .attr("text-anchor", "end")
      	 .text("Valor neto");

        var barras = g.selectAll(".bar")
         .data(myData)
         .enter().append("rect")
      	 .attr("class", "bar")
      	 .attr("x", function(d) {return 30; })
      	 .attr("y", function(d) {return y(d.key); })
      	 .attr("height", y.bandwidth())
      	 .attr("width", function(d) { return x(d.value); });
        
        barras.append("title")
            .text(function(d) { return d.value; });

    }
    
    function update2(myData, ageNames){
        var root = d3.hierarchy({children: myData})
                     .sum(function(d) { return d.value; })
                     .each(function(d) {
                         d.id       = d.data.key;
                         if (id = d.data.key) {
                            var name   = d.data.key.split('-'); 
                            d.category = name[0];
                            d.anio     = name[1];
                         }
                    });
        
        
        var node = svg.selectAll(".node")
                      .data(pack(root).leaves())
                      .enter().append("g")
                      .attr("class", "node")
                      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        
        node.append("circle")
            .attr("id", function(d) { return d.id; })
            .attr("r", function(d) { return d.r; })
            .style("fill", function(d) { return color(d.category); });
        
        node.append("clipPath")
            .attr("id", function(d) { return "clip-" + d.id; })
            .append("use")
            .attr("xlink:href", function(d) { return "#" + d.id; });
        
        var legend = svg.selectAll(".legend")
                    .data(ageNames)
                    .enter().append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
        
    
        legend.append("rect")
              .attr("x", width - 18)
              .attr("width", 18)
              .attr("height", 18)
              .style("fill", color);

        legend.append("text")
              .attr("x", width - 24)
              .attr("y", 9)
              .attr("dy", ".35em")
              .style("text-anchor", "end")
              .text(function(d) { return d; });

        node.append("text")
            .attr("clip-path", function(d) { return "url(#clip-" + d.anio + ")"; })
            .style("font-size","10px")
            .selectAll("tspan")
            .data(function(d) { if(d.r > 25) return d.anio; else return ''; })
            .enter().append("tspan")
            .attr("y", 0)
            .attr("x", function(d, i, nodes) { return 8 + (i - nodes.length / 2 - 0.5) * 10; })
            .text(function(d) { return d; });

        node.append("title")
            .text(function(d) { return d.id + "\n" + d.value; });
    }
    
    var cityInit = false;

    var yAxis = g2.append("g")
                  .attr("class", "axis axis--y")
                  .attr("transform", "translate(30," + 0 + ")");
    
    var xAxis =  g2.append("g")
                   .attr("class", "axis axis--x")
                   .attr("transform", "translate(30," + height2 + ")");
    
    function update3(cities, data){
        x2.domain(d3.extent(data, function(d) { return parseTime(d.date); }));

        y2.domain([
                    d3.min(cities, function(c) { return d3.min(c.values, function(d) { return d.value; }); }),
                    d3.max(cities, function(c) { return d3.max(c.values, function(d) { return d.value; }); })
                ]);

        z2.domain(cities.map(function(c) { return c.key; }));

        cityInit = g2.selectAll(".city")
                         .data(cities);
        
        cityEnter = cityInit.enter().append("g");
        
        cityInit.merge(cityEnter)
                .attr("class", "city")
                .append("path")
                .attr("class", "line")
                .attr("d", function(d) { return line(d.values); })
                .style("stroke", function(d) { return z2(d.key); });
        
        cityInit.exit().remove();
        
        xAxis.call(d3.axisBottom(x2));
        
        yAxis.call(d3.axisLeft(y2))
             .append("text")
             .attr("transform", "rotate(-90)")
             .attr("y", 6)
             .attr("dy", "0.71em")
             .attr("fill", "#000")
             .text("Valor neto, $");

        cityEnter.append("text")
            .datum(function(d) { return {id: d.key, value: d.values[d.values.length - 1]}; })
            .attr("transform", function(d) { return "translate(" + x2(parseTime(d.value.key)) + "," + y2(d.value.value) + ")"; })
            .attr("x", 3)
            .attr("dy", "0.35em")
            .style("font", "10px sans-serif")
            .text(function(d) {d3.select("#procesos").append("option").attr("value",d.id).text(d.id);return d.id; });
        
        // handle on click event
        d3.select('#procesos')
            .on('change', function() {
                var value = this.value;
                dataFiltered = data3.filter(function (d) { return d.key === value });
                console.log(dataFiltered);
                update3(dataFiltered, dataInit);
            });
    }
    
    // Lectura del archivo con los datos, y se generan los datos necesarios para las graficas necesarias
    // Se generan data2 (Datos para grafica de barras)
    // se generan data3 (Datos para grafica de bubble)
    d3.csv("data2.csv", type , function(err, data){
        var dataInit   = data;
        var legendData = new Array();
        var data1      = d3.nest()
                           .key(function(d) { if(legendData.indexOf(d["Procesos"]) == -1) legendData.push(d["Procesos"]);return d["Procesos"]; })
                           .rollup(function(v) { return d3.sum(v, function(d) { return d["Valor neto"]; }); })
                           .entries(data);
        
        var data2      = d3.nest()
                           .key(function(d) {return d["Procesos"]+'-'+d['Anio']; })
                           .rollup(function(v) { return d3.sum(v, function(d) { return d["Valor neto"]; }); })
                           .entries(data);  
        
        data3      = d3.nest()
                           .key(function(d) { return d["Procesos"]; })
                           .key(function(d) { return d.date; }).sortKeys(d3.ascending)
                           .rollup(function(v) { return d3.sum(v, function(d) { return d["Valor neto"]; }); })
                           .entries(data);

        update(data1);
        update2(data2, legendData);
        update3(data3, data);
    });
    
    function type(d, _, columns) {
        d.date = d['Fecha contabilizacion'];
        return d;
    }

</script>
